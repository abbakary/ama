{% extends 'tracker/base.html' %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="display-6 m-0">Orders</h2>
  <div class="d-flex gap-2 align-items-center">
    <form class="d-flex gap-2" method="get">
      <select name="status" class="form-select form-select-sm">
        <option
          value="all"
          {%
          if
          request.GET.status
          %}{%
          if
          request.GET.status=""
          ="all"
          %}selected{%
          endif
          %}{%
          else
          %}selected{%
          endif
          %}
        >
          All Statuses
        </option>
        <option
          value="created"
          {%
          if
          request.GET.status=""
          ="created"
          %}selected{%
          endif
          %}
        >
          Created
        </option>
        <option
          value="assigned"
          {%
          if
          request.GET.status=""
          ="assigned"
          %}selected{%
          endif
          %}
        >
          Assigned
        </option>
        <option
          value="in_progress"
          {%
          if
          request.GET.status=""
          ="in_progress"
          %}selected{%
          endif
          %}
        >
          In Progress
        </option>
        <option
          value="completed"
          {%
          if
          request.GET.status=""
          ="completed"
          %}selected{%
          endif
          %}
        >
          Completed
        </option>
        <option
          value="cancelled"
          {%
          if
          request.GET.status=""
          ="cancelled"
          %}selected{%
          endif
          %}
        >
          Cancelled
        </option>
      </select>
      <select name="type" class="form-select form-select-sm">
        <option
          value="all"
          {%
          if
          request.GET.type
          %}{%
          if
          request.GET.type=""
          ="all"
          %}selected{%
          endif
          %}{%
          else
          %}selected{%
          endif
          %}
        >
          All Types
        </option>
        <option
          value="service"
          {%
          if
          request.GET.type=""
          ="service"
          %}selected{%
          endif
          %}
        >
          Service
        </option>
        <option
          value="sales"
          {%
          if
          request.GET.type=""
          ="sales"
          %}selected{%
          endif
          %}
        >
          Sales
        </option>
        <option
          value="consultation"
          {%
          if
          request.GET.type=""
          ="consultation"
          %}selected{%
          endif
          %}
        >
          Consultation
        </option>
      </select>
      <button class="btn btn-outline-secondary btn-sm">Filter</button>
    </form>
    <a
      class="btn btn-outline-secondary btn-sm"
      href="{% url 'tracker:orders_export' %}?{{ request.GET.urlencode }}"
      ><i class="bi bi-download"></i> Export CSV</a
    >
  </div>
</div>
<div class="card shadow-sm">
  <div class="card-body table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Order</th>
          <th>Customer</th>
          <th>Type</th>
          <th>Status</th>
          <th>Priority</th>
          <th>Vehicle</th>
          <th>Created</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for o in orders %}
        <tr>
          <td>
            <a href="{% url 'tracker:order_detail' o.id %}"
              >{{ o.order_number }}</a
            >
          </td>
          <td>
            <a href="{% url 'tracker:customer_detail' o.customer.id %}"
              >{{ o.customer.full_name }}</a
            >
          </td>
          <td>{{ o.type|title }}</td>
          <td>
            <span class="pill pill-{{ o.status }}">{{ o.status|upper }}</span>
          </td>
          <td>
            <span class="pill pill-priority-{{ o.priority }}"
              >{{ o.priority|upper }}</span
            >
          </td>
          <td>
            {% if o.vehicle %}{{ o.vehicle.plate_number }}{% else %}-{% endif %}
          </td>
          <td>{{ o.created_at|date:'Y-m-d H:i' }}</td>
          <td class="text-end">
            <form
              method="post"
              action="{% url 'tracker:update_order_status' o.id %}"
              class="d-inline-flex align-items-center gap-2"
            >
              {% csrf_token %}
              <select
                name="status"
                class="form-select form-select-sm js-status-select"
              >
                {% for val,label in o.STATUS_CHOICES %}
                <option
                  value="{{ val }}"
                  {%
                  if
                  o.status=""
                  ="val"
                  %}selected{%
                  endif
                  %}
                >
                  {{ label }}
                </option>
                {% endfor %}
              </select>
              <button class="btn btn-sm btn-primary">Update</button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-muted">No orders.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
